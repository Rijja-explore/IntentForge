const hre = require("hardhat");
const path = require("path");
const fs   = require("fs");

/**
 * deploy-intent.js
 *
 * Deploys IntentForge.sol and auto-writes the contract address + ABI into
 *   ../src/config/contracts.js
 * so the React frontend is always in sync without manual copy-paste.
 *
 * Run:
 *   npx hardhat run scripts/deploy-intent.js --network localhost
 */
async function main() {
  console.log("\nğŸš€ Deploying IntentForge (Role-Based Fund Contract)...\n");

  // â”€â”€ Account layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const signers = await hre.ethers.getSigners();
  const lender   = signers[0];   // Account 0 â€” Rule Imposer
  const receiver = signers[1];   // Account 1 â€” Restricted User

  console.log("ğŸ“‹ Role Configuration:");
  console.log("â”œâ”€ Lender   (Account 0):", lender.address);
  console.log("â””â”€ Receiver (Account 1):", receiver.address);
  console.log();

  // â”€â”€ Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const IntentForge = await hre.ethers.getContractFactory("IntentForge");
  const contract    = await IntentForge.deploy();
  await contract.waitForDeployment();

  const contractAddress = await contract.getAddress();
  console.log("âœ… IntentForge deployed to:", contractAddress);
  console.log("âœ… Network:", hre.network.name);
  console.log();

  // â”€â”€ Load ABI from compiled artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const artifactPath = path.join(
    __dirname,
    "../artifacts/contracts/IntentForge.sol/IntentForge.json"
  );
  const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));
  const abi = artifact.abi;

  // â”€â”€ Write contracts.js for the React frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const contractsConfigPath = path.join(
    __dirname,
    "../../src/config/contracts.js"
  );

  const configContent = `/* â”€â”€â”€ Auto-generated by deploy-intent.js â€” do not edit manually â”€â”€â”€ */
/* Last deployed: ${new Date().toISOString()} */

export const INTENT_FORGE_ADDRESS = "${contractAddress}";

export const LENDER_ADDRESS   = "${lender.address}";
export const RECEIVER_ADDRESS = "${receiver.address}";

export const CHAIN_ID = ${hre.network.config.chainId || 31337};
export const RPC_URL  = "http://127.0.0.1:8545";

export const INTENT_FORGE_ABI = ${JSON.stringify(abi, null, 2)};
`;

  fs.writeFileSync(contractsConfigPath, configContent, "utf8");
  console.log("ğŸ“ Frontend config written to src/config/contracts.js");
  console.log();

  // â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  console.log("ğŸ¯ Deployment Summary");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("Contract  :", contractAddress);
  console.log("Lender    :", lender.address);
  console.log("Receiver  :", receiver.address);
  console.log("Network   :", hre.network.name);
  console.log("Chain ID  :", hre.network.config.chainId || 31337);
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log();
  console.log("Next steps:");
  console.log("  1. Import Account 0 & Account 1 into MetaMask");
  console.log("     RPC: http://127.0.0.1:8545  |  Chain ID: 31337");
  console.log("  2. npm start  (frontend already has the new address)");
  console.log("  3. Open http://localhost:3000/intent");
  console.log();
  console.log("âœ… Ready to demo!\n");
}

main()
  .then(() => process.exit(0))
  .catch((err) => {
    console.error("âŒ Deploy failed:", err);
    process.exit(1);
  });
